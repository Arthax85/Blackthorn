<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body class="dark-theme">
    <div class="container auth-container">
        <div class="container auth-container">
            <div id="admin-login" style="display: none;">
                <h2>Login Administrativo</h2>
                <input type="password" id="admin-secret" placeholder="Admin Secret">
                <button onclick="loginAdmin()" class="btn-edit">Acceder</button>
            </div>
        <h1 class="title">Panel de Administración</h1>
        <div class="stats-panel">
            <div class="stat-item">
                <h3>Total Usuarios</h3>
                <span id="total-users">0</span>
            </div>
            <div class="stat-item">
                <h3>Últimos Registros</h3>
                <span id="recent-registrations">0</span>
            </div>
        </div>
        <div id="error-message" style="display: none;" class="message error"></div>
        <table class="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Rol</th>
                    <th>Fecha de Registro</th>
                    <th>Último Acceso</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="users-list">
                <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>

    <script>
        async function loadUsers() {
            try {
                const response = await fetch('https://blackthorn-auth.onrender.com/api/users', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error del servidor:', errorText);
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const data = await response.json();
                console.log('Respuesta del servidor:', data);

                // Verificar la estructura de datos
                if (!data || typeof data !== 'object') {
                    console.error('Datos recibidos:', data);
                    throw new Error('Formato de datos inválido');
                }

                // Si los usuarios vienen directamente como array
                const users = Array.isArray(data) ? data : data.users;

                if (!Array.isArray(users)) {
                    console.error('Estructura de datos:', data);
                    throw new Error('No se encontró el array de usuarios');
                }
                
                document.getElementById('total-users').textContent = users.length;
                document.getElementById('recent-registrations').textContent = 
                    users.filter(u => {
                        const date = new Date(u.created_at);
                        return (new Date() - date) < (24 * 60 * 60 * 1000);
                    }).length;
                
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = '';
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id || 'N/A'}</td>
                        <td>${user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.role || 'usuario'}</td>
                        <td>${user.created_at ? new Date(user.created_at).toLocaleString('es-ES') : 'N/A'}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleString('es-ES') : 'Nunca'}</td>
                        <td><span class="status-badge ${user.active ? 'active' : 'inactive'}">${user.active ? 'Activo' : 'Inactivo'}</span></td>
                        <td class="actions">
                            <button onclick="editUser('${user.id}')" class="btn-edit">Editar</button>
                            <button onclick="deleteUser('${user.id}')" class="btn-delete">Eliminar</button>
                        </td>
                    `;
                    usersList.appendChild(row);
                });
            } catch (error) {
                console.error('Error detallado:', error);
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = 'Error al cargar los usuarios: ' + error.message;
                errorDiv.style.display = 'block';
            }
        }

        // Añadir estas funciones después del loadUsers
        async function deleteUser(userId) {
            if (confirm('¿Estás seguro de que deseas eliminar este usuario?')) {
                try {
                    const response = await fetch(`https://blackthorn-auth.onrender.com/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
                            'X-Admin-Secret': localStorage.getItem('adminSecret')
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Error al eliminar el usuario');
                    }

                    alert('Usuario eliminado correctamente');
                    loadUsers();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function editUser(userId) {
            const user = await getUserDetails(userId);
            if (!user) return;

            const newName = prompt('Nuevo nombre:', user.name);
            const newEmail = prompt('Nuevo email:', user.email);
            
            if (newName && newEmail) {
                try {
                    const response = await fetch(`https://blackthorn-auth.onrender.com/api/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            name: newName,
                            email: newEmail
                        })
                    });

                    if (response.ok) {
                        alert('Usuario actualizado correctamente');
                        loadUsers(); // Recargar la lista
                    } else {
                        throw new Error('Error al actualizar el usuario');
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function getUserDetails(userId) {
            try {
                const response = await fetch(`https://blackthorn-auth.onrender.com/api/users/${userId}`, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                if (response.ok) {
                    return await response.json();
                }
                throw new Error('Error al obtener detalles del usuario');
            } catch (error) {
                alert('Error: ' + error.message);
                return null;
            }
        }

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>

<script>
    // Añadir esta función
    async function loginAdmin() {
        const secret = document.getElementById('admin-secret').value;
        try {
            const response = await fetch('https://blackthorn-auth.onrender.com/api/admin/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ secret })
            });

            if (response.ok) {
                const data = await response.json();
                localStorage.setItem('adminToken', data.token);
                localStorage.setItem('adminSecret', secret);
                document.getElementById('admin-login').style.display = 'none';
                loadUsers();
            } else {
                throw new Error('Credenciales inválidas');
            }
        } catch (error) {
            alert('Error de autenticación: ' + error.message);
        }
    }

    // Modificar el DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('adminToken')) {
            document.getElementById('admin-login').style.display = 'block';
        } else {
            loadUsers();
        }
    });
</script>